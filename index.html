<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>WorksTime - Hours Tracker (Blue)</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --accent:#4da6ff;
  --accent-soft:#3380cc;
  --bg1:#0a0e1a;
  --bg2:#141a2e;
  --panel:rgba(20,40,80,.35);
  --panel-line:rgba(77,166,255,.28);
  --text:#e3f0ff;
  --text-dim:#a3d0ff;
  --danger:#ff6b6b;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{max-width:100%;overflow-x:hidden}
body{
  font-family:'Share Tech Mono','Segoe UI',sans-serif;
  background:radial-gradient(circle at 35% 25%,#1a2a4d 0%,#0f1620 55%,#050810 100%);
  color:var(--text);
  min-height:100vh;
  padding:16px 14px 70px;
  direction:rtl;
  -webkit-font-smoothing:antialiased;
}
body.ltr{direction:ltr}
/* OPTIMIZED: Reduced animation complexity and removed expensive effects */
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:-1;
  background:
    repeating-linear-gradient(90deg,rgba(77,166,255,.04) 0 2px,transparent 2px 4px),
    repeating-linear-gradient(0deg,rgba(77,166,255,.035) 0 2px,transparent 2px 4px);
  opacity:.18;
}
/* REMOVED: Expensive scan animation */
@keyframes pulse{
  0%,100%{text-shadow:0 0 10px rgba(77,166,255,.5)}
  50%{text-shadow:0 0 14px rgba(77,166,255,.7)}
}
.container{
  width:100%;max-width:520px;margin:0 auto;
  background:linear-gradient(150deg,rgba(20,50,90,.45),rgba(10,25,45,.45));
  border:1px solid var(--panel-line);
  border-radius:20px;
  padding:26px 22px 34px;
  /* OPTIMIZED: Removed backdrop-filter for better performance */
  position:relative;
  box-shadow:0 8px 24px -10px rgba(0,0,0,.7);
}
.container::before{
  content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;
  background:linear-gradient(120deg,rgba(77,166,255,.25),rgba(77,166,255,0) 50%);
  opacity:.4;
}
.header{text-align:center;margin-bottom:20px}
.header h1{
  font-size:2.1rem;letter-spacing:2px;color:var(--accent);
  text-shadow:0 0 10px rgba(77,166,255,.6);
  position:relative;
  /* OPTIMIZED: Slower, less frequent animation */
  animation:pulse 5s ease-in-out infinite;
}
.header h1::after{
  content:"_";margin-right:6px;
  /* OPTIMIZED: Reduced blink frequency */
  animation:blink 1.5s steps(2,start) infinite;
  color:var(--accent-soft);
}
.ltr .header h1::after{margin-left:6px;margin-right:0}
@keyframes blink{50%{opacity:0}}
.controls-row{
  display:flex;flex-wrap:wrap;gap:14px;justify-content:space-between;margin-bottom:16px;
}
.language-toggle{display:flex;gap:6px}
.lang-btn{
  background:rgba(77,166,255,.08);border:1px solid rgba(77,166,255,.35);color:var(--text-dim);
  padding:8px 12px;font-size:12px;letter-spacing:1px;border-radius:8px;cursor:pointer;
  transition:.2s ease;text-transform:uppercase;
}
.lang-btn.active,.lang-btn:hover{
  color:var(--accent);border-color:var(--accent);
  /* OPTIMIZED: Reduced shadow blur */
  box-shadow:0 0 6px rgba(77,166,255,.35);
}
.mode-group,.shift-group{flex:1;min-width:150px}
.mode-label,.shift-label{
  font-size:11px;color:var(--accent);letter-spacing:1px;margin-bottom:4px;text-transform:uppercase;
}
.select-wrap{position:relative}
.select-wrap select{
  width:100%;padding:11px 14px;border:1px solid rgba(77,166,255,.35);
  background:rgba(15,30,60,.6);color:var(--accent);font-size:13.5px;border-radius:10px;
  cursor:pointer;appearance:none;direction:rtl;font-weight:600;
  transition:.2s ease;
}
body.ltr .select-wrap select{direction:ltr}
.select-wrap::after{
  content:"⌄";position:absolute;top:50%;transform:translateY(-50%);left:14px;
  color:var(--accent);pointer-events:none;font-size:13px;
}
body.ltr .select-wrap::after{right:14px;left:auto}
.select-wrap select:focus{
  outline:none;border-color:var(--accent);
  /* OPTIMIZED: Reduced shadow blur */
  box-shadow:0 0 0 2px rgba(77,166,255,.2);
}
.work-schedule{
  background:rgba(77,166,255,.07);border:1px solid rgba(77,166,255,.25);
  border-radius:16px;padding:16px 16px 18px;text-align:center;position:relative;
  margin-bottom:22px;overflow:hidden;
}
.work-schedule h3{color:var(--accent);font-size:.95rem;margin-bottom:6px;letter-spacing:.5px}
.schedule-time{font-size:.9rem;line-height:1.4;color:var(--text)}
.schedule-time span.key{color:var(--accent)}
.shift-info{display:flex;justify-content:space-between;margin-top:8px;font-size:.7rem;color:var(--text-dim);font-weight:600}
.shift-info .value{color:var(--accent)}
.section-title{
  margin:12px 0 10px;font-size:.85rem;color:var(--accent);letter-spacing:.5px;font-weight:600;
  display:flex;align-items:center;gap:6px;
}
.input-group{margin-bottom:18px}
.input-group label{display:block;margin-bottom:6px;color:var(--accent);font-size:.8rem;letter-spacing:.5px}
input[type=text]{
  width:100%;padding:12px 14px;border:1px solid rgba(77,166,255,.35);
  border-radius:10px;background:rgba(15,30,60,.55);color:var(--text);font-size:14px;
  transition:.2s ease;
}
input[type=text]:focus{
  outline:none;border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(77,166,255,.15);
}
.time-inputs{display:flex;gap:10px;direction:ltr;align-items:center}
.time-select{position:relative}
.time-select select{
  width:80px;padding:11px 10px;border:1px solid rgba(77,166,255,.35);background:rgba(15,30,60,.55);
  color:var(--accent);font-weight:600;border-radius:10px;text-align:center;cursor:pointer;appearance:none;direction:ltr;
  transition:.2s ease;
}
.time-select::after{
  content:"⌄";position:absolute;right:10px;top:50%;transform:translateY(-50%);
  font-size:11px;color:var(--accent);pointer-events:none;
}
.time-select select:focus{
  outline:none;border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(77,166,255,.15);
}
.time-separator{font-size:22px;font-weight:700;color:var(--accent)}
.calculate-btn{
  width:100%;padding:15px 18px;background:linear-gradient(95deg,#4da6ff,#3380cc 60%,#2660a0);
  border:none;border-radius:14px;color:#0a1625;font-size:15.5px;font-weight:700;letter-spacing:1px;
  cursor:pointer;transition:.25s ease;margin:4px 0 20px;
  /* OPTIMIZED: Add will-change for smoother animations */
  will-change:transform;
}
.calculate-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 16px -6px rgba(77,166,255,.45);
}
.calculate-btn:active{transform:translateY(0);box-shadow:0 4px 12px -6px rgba(77,166,255,.35)}
.results{
  display:none;background:rgba(77,166,255,.07);border:1px solid rgba(77,166,255,.28);
  border-radius:16px;padding:18px 16px 20px;position:relative;
}
.results.show{display:block;animation:fadeIn .4s ease}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}
.result-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 10px;margin-bottom:10px;background:rgba(77,166,255,.05);
  border:1px solid rgba(77,166,255,.18);border-radius:10px;font-size:.85rem;
}
.result-label{color:var(--text-dim);font-weight:600}
.result-value{font-weight:700;color:var(--text);direction:ltr}
.result-value.remaining-hours{
  color:var(--accent);font-size:1.15rem;
  text-shadow:0 0 8px rgba(77,166,255,.5);
}
.result-value.leave-time{
  color:var(--accent-soft);font-size:1.05rem;
  text-shadow:0 0 6px rgba(77,166,255,.35);
}
.action-buttons{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;
}
@media (max-width:460px){.action-buttons{grid-template-columns:1fr}.container{padding:24px 18px 30px}}
.action-btn{
  background:rgba(77,166,255,.1);border:1px solid rgba(77,166,255,.35);border-radius:10px;
  padding:11px 14px;font-size:12.5px;font-weight:600;color:var(--accent);cursor:pointer;
  letter-spacing:.5px;transition:.25s ease;text-align:center;
  will-change:transform;
}
.action-btn:hover{
  background:linear-gradient(135deg,#4da6ff,#2660a0);color:#0a1625;
  box-shadow:0 4px 12px -6px rgba(77,166,255,.45);
  transform:translateY(-1px);
}
.action-btn.danger{border-color:rgba(255,77,77,.4);color:#ff9b9b}
.action-btn.danger:hover{
  background:linear-gradient(135deg,#ff7777,#cc2626);color:#fff;
  box-shadow:0 4px 12px -6px rgba(255,70,70,.45);
}
.batch-wrapper{display:none;margin-top:6px}
.batch-wrapper.show{display:block;animation:fadeIn .3s ease}
.batch-table{
  width:100%;border-collapse:collapse;font-size:.72rem;margin-top:4px;
}
.batch-table thead th{
  background:rgba(77,166,255,.12);color:var(--accent);font-weight:600;padding:6px 4px;border:1px solid rgba(77,166,255,.25);
  white-space:nowrap;
}
.batch-table tbody td{
  padding:4px 3px;border:1px solid rgba(77,166,255,.18);
}
.batch-table select,.batch-table input{
  width:100%;padding:7px 6px;font-size:.68rem;
  background:rgba(15,30,60,.55);color:var(--accent);
  border:1px solid rgba(77,166,255,.3);border-radius:6px;direction:rtl;
}
body.ltr .batch-table select,body.ltr .batch-table input{direction:ltr}
.batch-table .time-pair{
  display:flex;gap:6px;justify-content:center;
  direction:ltr !important;
}
.batch-table .time-pair select{
  width:64px;
  min-width:64px;
  text-align:center;
  direction:ltr;
  font-size:.7rem;
  padding:6px 4px;
}
.batch-table .time-pair select::-webkit-scrollbar{width:6px}
.remove-row-btn{
  background:rgba(255,77,77,.12);border:1px solid rgba(255,77,77,.4);color:#ffb5b5;
  font-size:.6rem;border-radius:6px;padding:4px 6px;cursor:pointer;
  transition:.2s ease;width:100%;
}
.remove-row-btn:hover{background:#ff4d4d;color:#fff}
.batch-results-table{
  width:100%;border-collapse:collapse;font-size:.72rem;margin-top:10px;
}
.batch-results-table th,.batch-results-table td{
  border:1px solid rgba(77,166,255,.2);padding:6px 5px;text-align:center;
  white-space:nowrap;
}
.batch-results-table th{
  background:rgba(77,166,255,.15);color:var(--accent);font-weight:600;
}
.notification{
  position:fixed;bottom:16px;inset-inline:0;width:fit-content;max-width:90%;margin:0 auto;
  background:#1a3050;border:1px solid rgba(77,166,255,.4);color:var(--accent);
  padding:14px 20px;border-radius:14px;font-size:.8rem;letter-spacing:.5px;
  font-weight:600;opacity:0;transform:translateY(30px);transition:.35s ease;z-index:1000;
  box-shadow:0 6px 16px -6px rgba(77,166,255,.45);
}
.notification.show{opacity:1;transform:translateY(0)}
.hidden-canvas{position:absolute;left:-9999px;top:-9999px}

/* Checkboxes for results display */
.result-filters{
  background:rgba(77,166,255,.05);border:1px solid rgba(77,166,255,.2);
  border-radius:10px;padding:12px;margin-bottom:16px;
}
.result-filters h4{
  color:var(--accent);font-size:.85rem;margin-bottom:8px;letter-spacing:.5px;
}
.filter-options{
  display:flex;flex-wrap:wrap;gap:10px;
}
.filter-option{
  display:flex;align-items:center;gap:6px;
}
.filter-option input[type="checkbox"]{
  width:18px;height:18px;cursor:pointer;
  accent-color:var(--accent);
}
.filter-option label{
  font-size:.78rem;color:var(--text-dim);cursor:pointer;
  user-select:none;
}

</style>
</head>
<body>
  <div class="container">
    <div class="controls-row">
      <div class="language-toggle">
        <button class="lang-btn" onclick="setLanguage(this,'en')">English</button>
        <button class="lang-btn active" onclick="setLanguage(this,'ar')">العربية</button>
      </div>
      <div class="mode-group">
        <div class="mode-label" data-en="Mode" data-ar="الوضع">الوضع</div>
        <div class="select-wrap">
          <select id="modeSelect" onchange="switchMode(this.value)">
            <option value="single" data-en="Single Entry" data-ar="مُدخل واحد">مُدخل واحد</option>
            <option value="batch" data-en="Batch (Multiple)" data-ar="متعدد (دفعة)">متعدد (دفعة)</option>
          </select>
        </div>
      </div>
      <div class="shift-group single-only">
        <div class="shift-label" data-en="Work Shift" data-ar="نوع الوردية">نوع الوردية</div>
        <div class="select-wrap">
          <select id="shiftSelect" onchange="setShift(this.value)">
            <option value="morning" data-en="🌅 Morning Shift" data-ar="🌅 الوردية الصباحية">🌅 الوردية الصباحية</option>
            <option value="morning2" data-en="🎈 Morning Shift 2" data-ar="🎈 الوردية الصباحية 2">🎈 الوردية الصباحية 2</option>
            <option value="evening" data-en="🌆 Evening Shift" data-ar="🌆 الوردية المسائية">🌆 الوردية المسائية</option>
            <option value="evening2" data-en="🔧 Evening Shift 2" data-ar="🔧 الوردية المسائية 2">🔧 الوردية المسائية 2</option>
          </select>
        </div>
      </div>
    </div>

    <div class="header">
      <h1 data-en="WorksTime" data-ar="أوقات العمل">أوقات العمل</h1>
    </div>

    <div id="singleSchedule" class="work-schedule">
      <h3 data-en="📅 Work Schedule" data-ar="📅 جدول العمل">📅 جدول العمل</h3>
      <div class="schedule-time">
        <span class="key" data-en="Start:" data-ar="البداية:">البداية:</span>
        <span id="startTime">7:15 AM</span> |
        <span class="key" data-en="End:" data-ar="النهاية:">النهاية:</span>
        <span id="endTime">3:15 PM</span><br>
        <span class="key" data-en="Daily Hours:" data-ar="الساعات اليومية:">الساعات اليومية:</span>
        <span id="dailyHours">8 hours</span>
      </div>
      <div class="shift-info">
        <span data-en="Monthly Total:" data-ar="المجموع الشهري:">المجموع الشهري:</span>
        <span class="value">22 hours</span>
      </div>
    </div>

    <!-- Single mode inputs -->
    <div id="singleInputs">
      <div class="input-group">
        <label for="employeeName" data-en="👤 Employee Name (Optional)" data-ar="👤 اسم الموظف (اختياري)">👤 اسم الموظف (اختياري)</label>
        <input type="text" id="employeeName" data-en-placeholder="Enter your name (optional)" data-ar-placeholder="أدخل اسمك (اختياري)" placeholder="أدخل اسمك (اختياري)">
      </div>

      <div class="input-group">
        <label data-en="⏱️ Used Hours" data-ar="⏱️ الساعات المستخدمة">⏱️ الساعات المستخدمة</label>
        <div class="time-inputs">
          <div class="time-select">
            <select id="usedHours">
              <option value="0">0</option>
              <script>
                document.addEventListener('DOMContentLoaded',()=> {
                  const sel=document.getElementById('usedHours');
                  for(let i=1;i<=22;i++){const o=document.createElement('option');o.value=i;o.textContent=i;sel.appendChild(o);}
                });
              </script>
            </select>
          </div>
          <span class="time-separator">:</span>
          <div class="time-select">
            <select id="usedMinutes">
              <script>
                document.addEventListener('DOMContentLoaded',()=>{
                  const mins=document.getElementById('usedMinutes');
                  for(let i=0;i<60;i++){const o=document.createElement('option');o.value=i;o.textContent=i.toString().padStart(2,'0');mins.appendChild(o);}
                });
              </script>
            </select>
          </div>
        </div>
      </div>

      <button class="calculate-btn" id="calcSingleBtn" onclick="calculateResults()" data-en="🧮 Calculate Results" data-ar="🧮 احسب النتائج">🧮 احسب النتائج</button>

      <!-- Result Filters -->
      <div class="result-filters" id="resultFilters" style="display:none;">
        <h4 data-en="🔍 Display Options:" data-ar="🔍 خيارات العرض:">🔍 خيارات العرض:</h4>
        <div class="filter-options">
          <div class="filter-option">
            <input type="checkbox" id="showShift" checked onchange="toggleResultDisplay()">
            <label for="showShift" data-en="Shift" data-ar="الوردية">الوردية</label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="showRemaining" checked onchange="toggleResultDisplay()">
            <label for="showRemaining" data-en="Remaining Hours" data-ar="الساعات المتبقية">الساعات المتبقية</label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="showLeave" checked onchange="toggleResultDisplay()">
            <label for="showLeave" data-en="Leave Time" data-ar="وقت الخروج">وقت الخروج</label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="showUsed" checked onchange="toggleResultDisplay()">
            <label for="showUsed" data-en="Hours Used" data-ar="الساعات المستخدمة">الساعات المستخدمة</label>
          </div>
        </div>
      </div>

      <div class="results" id="results">
        <div class="result-item" id="resultShift">
          <span class="result-label" data-en="📋 Shift:" data-ar="📋 الوردية:">📋 الوردية:</span>
          <span class="result-value" id="shiftName">-</span>
        </div>
        <div class="result-item" id="resultRemaining">
          <span class="result-label" data-en="🎯 Remaining Hours:" data-ar="🎯 الساعات المتبقية:">🎯 الساعات المتبقية:</span>
          <span class="result-value remaining-hours" id="remainingHours">-</span>
        </div>
        <div class="result-item" id="resultLeave">
          <span class="result-label" data-en="🚪 Can Leave At:" data-ar="🚪 وقت الخروج:">🚪 وقت الخروج:</span>
          <span class="result-value leave-time" id="leaveTime">-</span>
        </div>
        <div class="result-item" id="resultUsed">
          <span class="result-label" data-en="📊 Hours Used:" data-ar="📊 الساعات المستخدمة:">📊 الساعات المستخدمة:</span>
          <span class="result-value" id="hoursUsed">-</span>
        </div>

        <div class="action-buttons">
          <button class="action-btn" onclick="saveAsPDF()" data-en="� Save PDF" data-ar="� حفظ PDF">� حفظ PDF</button>
          <button class="action-btn" onclick="saveAsImage()" data-en="📸 Save Image" data-ar="📸 حفظ صورة">📸 حفظ صورة</button>
          <button class="action-btn" onclick="copyResults()" data-en="📋 Copy" data-ar="📋 نسخ">📋 نسخ</button>
        </div>
      </div>
    </div>

    <!-- Batch Mode -->
    <div id="batchWrapper" class="batch-wrapper">
      <div class="section-title" data-en="Batch Entries" data-ar="مُدخلات الدفعة">مُدخلات الدفعة</div>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
        <button class="action-btn" onclick="addBatchRow()" data-en="➕ Add Row" data-ar="➕ إضافة صف">➕ إضافة صف</button>
        <button class="action-btn" onclick="calculateBatch()" data-en="🧮 Calculate Batch" data-ar="🧮 احسب الدفعة">🧮 احسب الدفعة</button>
        <button class="action-btn" onclick="saveBatchAsPDF()" data-en="� Save PDF" data-ar="� حفظ PDF">� حفظ PDF</button>
        <button class="action-btn" onclick="saveBatchAsImage()" data-en="� Save Image" data-ar="� حفظ صورة">� حفظ صورة</button>
        <button class="action-btn" onclick="copyBatchSummary()" data-en="� Copy Summary" data-ar="� نسخ الملخص">� نسخ الملخص</button>
        <button class="action-btn danger" onclick="clearBatch()" data-en="🗑️ Clear" data-ar="🗑️ مسح">🗑️ مسح</button>
      </div>
      <div style="overflow-x:auto">
        <table class="batch-table" id="batchTable">
          <thead>
            <tr>
              <th data-en="#" data-ar="#">#</th>
              <th data-en="Name" data-ar="الاسم">الاسم</th>
              <th data-en="Shift" data-ar="الوردية">الوردية</th>
              <th data-en="Used" data-ar="المستخدمة">المستخدمة</th>
              <th data-en="Actions" data-ar="إجراءات">إجراءات</th>
            </tr>
          </thead>
          <tbody id="batchTbody"></tbody>
        </table>
      </div>

      <div id="batchResultsContainer" style="display:none;margin-top:14px">
        <div class="section-title" data-en="Batch Results" data-ar="نتائج الدفعة">نتائج الدفعة</div>
        <div style="overflow-x:auto">
          <table class="batch-results-table" id="batchResultsTable">
            <thead>
              <tr>
                <th data-en="#" data-ar="#">#</th>
                <th data-en="Name" data-ar="الاسم">الاسم</th>
                <th data-en="Shift" data-ar="الوردية">الوردية</th>
                <th data-en="Used" data-ar="المستخدمة">المستخدمة</th>
                <th data-en="Remaining" data-ar="المتبقي">المتبقي</th>
                <th data-en="Leave At" data-ar="الخروج">الخروج</th>
              </tr>
            </thead>
            <tbody id="batchResultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <canvas id="canvas" class="hidden-canvas"></canvas>
  <div id="notification" class="notification"></div>

  <!-- OPTIMIZED: Audio with lower volume and debouncing -->
  <audio id="clickSound" preload="none"><source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEYBjiQ2O/TgTAHKnfE9t2QQQsUXrTp66hUFApGn+DyvmEYBjiQ2O/TgTAHKnfJ3+8=" type="audio/wav"></audio>
  <audio id="resultSound" preload="none"><source src="data:audio/wav;base64,UklGRu4CAABXQVZFZm10IBAAAAABAAEAVFYAAKhWAQACABAAZGF0YcoCAADn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn" type="audio/wav"></audio>

<script>
let currentLanguage='ar';
let currentShift='morning';
let currentResults={};
let batchRows=0;
let batchData=[];
// OPTIMIZED: Debounce timers for sound
let soundTimeout=null;

const shifts={
  morning:{startTime:'7:15 AM',endTime:'3:15 PM',dailyHours:8,startHour:7,startMinute:15,endHour:15,endMinute:15},
  morning2:{startTime:'7:00 AM',endTime:'1:00 PM',dailyHours:6,startHour:7,startMinute:0,endHour:13,endMinute:0},
  evening:{startTime:'1:00 PM',endTime:'7:00 PM',dailyHours:6,startHour:13,startMinute:0,endHour:19,endMinute:0},
  evening2:{startTime:'2:00 PM',endTime:'9:00 PM',dailyHours:7,startHour:14,startMinute:0,endHour:21,endMinute:0}
};

// OPTIMIZED: Debounced sound with volume control
function playSound(id){
  if(soundTimeout) return; // Prevent spam
  const a=document.getElementById(id);
  if(a){
    a.volume=0.2; // Lower volume
    a.currentTime=0;
    a.play().catch(()=>{});
    soundTimeout=setTimeout(()=>soundTimeout=null,100); // 100ms debounce
  }
}

function setLanguage(btn,lang){
  currentLanguage=lang;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');

  if(lang==='ar'){
    document.body.classList.remove('ltr');
    document.documentElement.lang='ar';
    document.documentElement.dir='rtl';
  }else{
    document.body.classList.add('ltr');
    document.documentElement.lang='en';
    document.documentElement.dir='ltr';
  }

  document.querySelectorAll('[data-'+lang+']').forEach(el=>{
    el.textContent=el.getAttribute('data-'+lang);
  });
  document.querySelectorAll('[data-'+lang+'-placeholder]').forEach(el=>{
    el.placeholder=el.getAttribute('data-'+lang+'-placeholder');
  });
  document.querySelectorAll('#shiftSelect option,#modeSelect option,#batchTbody select option').forEach(o=>{
    const t=o.getAttribute('data-'+lang);
    if(t) o.textContent=t;
  });
  document.querySelectorAll('.batch-table thead [data-'+lang+'], .batch-results-table thead [data-'+lang+']').forEach(th=>{
    th.textContent=th.getAttribute('data-'+lang);
  });

  updateShiftDisplay();
  updateBatchShiftLabels();
  playSound('clickSound');
}

function setShift(value){
  if(!shifts[value]) return;
  currentShift=value;
  updateShiftDisplay();
  if(document.getElementById('results').classList.contains('show')) calculateResults();
  playSound('clickSound');
}

function updateShiftDisplay(){
  const s=shifts[currentShift];
  if(!s) return;
  document.getElementById('startTime').textContent=s.startTime;
  document.getElementById('endTime').textContent=s.endTime;
  document.getElementById('dailyHours').textContent=s.dailyHours+' hours';
}

function formatTime(h,m){
  const period=h>=12?'PM':'AM';
  const display=h>12? h-12 : (h===0?12:h);
  return display+':'+m.toString().padStart(2,'0')+' '+period;
}

function calcForShift(shiftKey,usedH,usedM){
  const usedMinutes=usedH*60+usedM;
  const totalWork=22*60;
  let remaining=totalWork-usedMinutes;
  if(remaining<0) remaining=0;
  const remH=Math.floor(remaining/60);
  const remM=remaining%60;
  const s=shifts[shiftKey];
  let leaveMins=(s.endHour*60+s.endMinute)-remaining;
  let leaveH=Math.floor(leaveMins/60);
  let leaveMin=leaveMins%60;
  if(leaveMin<0){leaveH--;leaveMin+=60;}
  const startTotal=s.startHour*60+s.startMinute;
  const endTotal=s.endHour*60+s.endMinute;
  if(leaveMins<startTotal){leaveH=s.startHour;leaveMin=s.startMinute;}
  if(leaveMins>endTotal){leaveH=s.endHour;leaveMin=s.endMinute;}
  return {
    remainingHours: remH+':'+remM.toString().padStart(2,'0'),
    leaveTime: formatTime(leaveH,leaveMin),
    used: usedH+':'+usedM.toString().padStart(2,'0')
  };
}

function calculateResults(){
  const usedH=parseInt(document.getElementById('usedHours').value)||0;
  const usedM=parseInt(document.getElementById('usedMinutes').value)||0;
  const r=calcForShift(currentShift,usedH,usedM);
  document.getElementById('remainingHours').textContent=r.remainingHours;
  document.getElementById('leaveTime').textContent=r.leaveTime;
  document.getElementById('hoursUsed').textContent=r.used;
  const namesMap={
    morning: currentLanguage==='ar'?'الوردية الصباحية':'Morning Shift',
    morning2: currentLanguage==='ar'?'الوردية الصباحية 2':'Morning Shift 2',
    evening: currentLanguage==='ar'?'الوردية المسائية':'Evening Shift',
    evening2: currentLanguage==='ar'?'الوردية المسائية 2':'Evening Shift 2'
  };
  document.getElementById('shiftName').textContent=namesMap[currentShift];
  currentResults={
    name:document.getElementById('employeeName').value.trim(),
    shift:namesMap[currentShift],
    usedHours:r.used,
    remainingHours:r.remainingHours,
    leaveTime:r.leaveTime
  };
  document.getElementById('resultFilters').style.display='block';
  document.getElementById('results').classList.add('show');
  toggleResultDisplay();
  playSound('resultSound');
}

function toggleResultDisplay(){
  const showShift=document.getElementById('showShift').checked;
  const showRemaining=document.getElementById('showRemaining').checked;
  const showLeave=document.getElementById('showLeave').checked;
  const showUsed=document.getElementById('showUsed').checked;
  
  document.getElementById('resultShift').style.display=showShift?'flex':'none';
  document.getElementById('resultRemaining').style.display=showRemaining?'flex':'none';
  document.getElementById('resultLeave').style.display=showLeave?'flex':'none';
  document.getElementById('resultUsed').style.display=showUsed?'flex':'none';
}

function copyResults(){
  if(!currentResults.leaveTime) calculateResults();
  
  // Get checkbox states
  const showShift=document.getElementById('showShift').checked;
  const showRemaining=document.getElementById('showRemaining').checked;
  const showLeave=document.getElementById('showLeave').checked;
  const showUsed=document.getElementById('showUsed').checked;
  
  const labels=currentLanguage==='ar'?{
    shift:'الوردية',used:'الساعات المستخدمة',remaining:'الساعات المتبقية',leave:'وقت الخروج',generated:'تم الإنشاء'
  }:{
    shift:'Shift',used:'Used Hours',remaining:'Remaining Hours',leave:'Can Leave At',generated:'Generated'
  };
  const name=currentResults.name?(currentResults.name+'\n'):'';
  
  // Build text based on checkbox states
  let text='';
  if(name) text+=name+'\n';
  if(showShift) text+=`${labels.shift}: ${currentResults.shift}\n`;
  if(showUsed) text+=`${labels.used}: ${currentResults.usedHours}\n`;
  if(showRemaining) text+=`${labels.remaining}: ${currentResults.remainingHours}\n`;
  if(showLeave) text+=`${labels.leave}: ${currentResults.leaveTime}\n`;
  text+=`${labels.generated}: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
  
  navigator.clipboard.writeText(text).then(()=>showNotification(currentLanguage==='ar'?'تم النسخ!':'Copied!')).catch(()=>showNotification(currentLanguage==='ar'?'فشل النسخ':'Copy failed'));
}

function saveAsPDF(){
  if(!currentResults.leaveTime) calculateResults();
  
  // Get checkbox states
  const showShift=document.getElementById('showShift').checked;
  const showRemaining=document.getElementById('showRemaining').checked;
  const showLeave=document.getElementById('showLeave').checked;
  const showUsed=document.getElementById('showUsed').checked;
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Set background color
  doc.setFillColor(15, 22, 32);
  doc.rect(0, 0, 210, 297, 'F');
  
  // Employee name if exists
  let yPos = 30;
  if(currentResults.name){
    doc.setFontSize(16);
    doc.setTextColor(77, 166, 255);
    doc.text(currentResults.name, 105, yPos, { align: 'center' });
    yPos += 20;
  }
  
  // Results
  doc.setFontSize(12);
  doc.setTextColor(227, 240, 255);
  const labels=currentLanguage==='ar'?{
    shift:'الوردية',used:'المستخدمة',remaining:'المتبقية',leave:'الخروج'
  }:{
    shift:'Shift',used:'Used',remaining:'Remaining',leave:'Leave'
  };
  
  if(showShift){
    doc.text(`${labels.shift}: ${currentResults.shift}`, 20, yPos);
    yPos += 10;
  }
  if(showUsed){
    doc.text(`${labels.used}: ${currentResults.usedHours}`, 20, yPos);
    yPos += 10;
  }
  if(showRemaining){
    doc.text(`${labels.remaining}: ${currentResults.remainingHours}`, 20, yPos);
    yPos += 10;
  }
  if(showLeave){
    doc.text(`${labels.leave}: ${currentResults.leaveTime}`, 20, yPos);
    yPos += 10;
  }
  
  // Footer
  doc.setFontSize(10);
  doc.setTextColor(77, 166, 255);
  const genLabel=currentLanguage==='ar'?'تم الإنشاء':'Generated';
  doc.text(`${genLabel}: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 280, { align: 'center' });
  
  doc.save('workstime-'+currentShift+'-'+new Date().toISOString().slice(0,10)+'.pdf');
  showNotification(currentLanguage==='ar'?'تم حفظ PDF':'PDF saved');
}

function saveAsImage(){
  if(!currentResults.leaveTime) calculateResults();
  
  // Get checkbox states
  const showShift=document.getElementById('showShift').checked;
  const showRemaining=document.getElementById('showRemaining').checked;
  const showLeave=document.getElementById('showLeave').checked;
  const showUsed=document.getElementById('showUsed').checked;
  
  const c=document.getElementById('canvas');const ctx=c.getContext('2d');
  c.width=640;c.height=420;
  const g=ctx.createLinearGradient(0,0,640,420);g.addColorStop(0,'#0f1620');g.addColorStop(1,'#050810');
  ctx.fillStyle=g;ctx.fillRect(0,0,640,420);
  ctx.strokeStyle='rgba(77,166,255,0.08)';ctx.lineWidth=1;
  for(let x=0;x<=640;x+=32){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,420);ctx.stroke();}
  for(let y=0;y<=420;y+=32){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(640,y);ctx.stroke();}
  ctx.strokeStyle='rgba(77,166,255,.55)';ctx.lineWidth=3;ctx.strokeRect(10,10,620,400);
  
  let y=60;
  if(currentResults.name){
    ctx.fillStyle='#4da6ff';ctx.font='bold 26px Share Tech Mono';ctx.textAlign='center';
    ctx.shadowColor='rgba(77,166,255,.7)';ctx.shadowBlur=16;
    ctx.fillText(currentResults.name,320,y);ctx.shadowBlur=0;
    y+=50;
  }else{
    y=100;
  }
  
  ctx.textAlign=currentLanguage==='ar'?'right':'left';
  const x=currentLanguage==='ar'?590:50;
  ctx.fillStyle='#e3f0ff';ctx.font='18px Share Tech Mono';
  
  // Build lines array based on checkbox states
  const lines=[];
  if(currentLanguage==='ar'){
    if(showShift) lines.push('الوردية: '+currentResults.shift);
    if(showUsed) lines.push('المستخدمة: '+currentResults.usedHours);
    if(showRemaining) lines.push('المتبقية: '+currentResults.remainingHours);
    if(showLeave) lines.push('الخروج: '+currentResults.leaveTime);
  }else{
    if(showShift) lines.push('Shift: '+currentResults.shift);
    if(showUsed) lines.push('Used: '+currentResults.usedHours);
    if(showRemaining) lines.push('Remaining: '+currentResults.remainingHours);
    if(showLeave) lines.push('Leave: '+currentResults.leaveTime);
  }
  
  lines.forEach((ln,i)=>ctx.fillText(ln,x,y+i*34));
  ctx.textAlign='center';ctx.fillStyle='#4da6ff';ctx.font='14px Share Tech Mono';
  const genLabel=currentLanguage==='ar'?'تم الإنشاء':'Generated';
  ctx.fillText(`${genLabel}: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`,320,370);
  c.toBlob(b=>{
    const url=URL.createObjectURL(b);
    const a=document.createElement('a');
    a.href=url;
    a.download='workstime-'+currentShift+'-'+new Date().toISOString().slice(0,10)+'.png';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(currentLanguage==='ar'?'تم حفظ الصورة':'Image saved');
  });
}

function showNotification(msg){
  const n=document.getElementById('notification');
  n.textContent=msg;n.classList.add('show');
  clearTimeout(showNotification._t);
  showNotification._t=setTimeout(()=>n.classList.remove('show'),3000);
}

function switchMode(mode){
  const singleParts=[document.getElementById('singleSchedule'),document.getElementById('singleInputs')];
  const batchWrapper=document.getElementById('batchWrapper');
  if(mode==='batch'){
    singleParts.forEach(el=>el.style.display='none');
    batchWrapper.classList.add('show');
    if(batchRows===0) addBatchRow();
  }else{
    singleParts.forEach(el=>el.style.display='block');
    batchWrapper.classList.remove('show');
  }
  playSound('clickSound');
}

function addBatchRow(){
  batchRows++;
  const tbody=document.getElementById('batchTbody');
  const tr=document.createElement('tr');
  tr.dataset.row=batchRows;
  tr.innerHTML=`
    <td>${batchRows}</td>
    <td><input type="text" placeholder="${currentLanguage==='ar'?'اسم':'Name'}"/></td>
    <td>
      <select class="batch-shift">
        <option value="morning" data-en="🌅 Morning" data-ar="🌅 صباحي">${currentLanguage==='ar'?'🌅 صباحي':'🌅 Morning'}</option>
        <option value="morning2" data-en="🎈 Morning 2" data-ar="🎈 صباحي 2">${currentLanguage==='ar'?'🎈 صباحي 2':'🎈 Morning 2'}</option>
        <option value="evening" data-en="🌆 Evening" data-ar="🌆 مسائي">${currentLanguage==='ar'?'🌆 مسائي':'🌆 Evening'}</option>
        <option value="evening2" data-en="🔧 Evening 2" data-ar="🔧 مسائي 2">${currentLanguage==='ar'?'🔧 مسائي 2':'🔧 Evening 2'}</option>
      </select>
    </td>
    <td>
      <div class="time-pair">
        <select class="usedH">${Array.from({length:23},(_,i)=>`<option value="${i}">${i}</option>`).join('')}</select>
        <select class="usedM">${Array.from({length:60},(_,i)=>`<option value="${i}">${i.toString().padStart(2,'0')}</option>`).join('')}</select>
      </div>
    </td>
    <td><button class="remove-row-btn" onclick="removeBatchRow(this)">${currentLanguage==='ar'?'حذف':'Delete'}</button></td>
  `;
  tbody.appendChild(tr);
  playSound('clickSound');
}

function removeBatchRow(btn){
  const tr=btn.closest('tr');
  tr.remove();
  batchRows=0;
  document.querySelectorAll('#batchTbody tr').forEach((r,i)=>{
    batchRows=i+1;
    r.dataset.row=batchRows;
    r.firstElementChild.textContent=batchRows;
  });
  playSound('clickSound');
}

function clearBatch(){
  document.getElementById('batchTbody').innerHTML='';
  document.getElementById('batchResultsContainer').style.display='none';
  batchRows=0;
  batchData=[];
  showNotification(currentLanguage==='ar'?'تم المسح':'Cleared');
  playSound('clickSound');
}

function updateBatchShiftLabels(){
  document.querySelectorAll('#batchTbody select.batch-shift').forEach(sel=>{
    sel.querySelectorAll('option').forEach(o=>{
      const t=o.getAttribute('data-'+currentLanguage);
      if(t) o.textContent=t;
    });
  });
}

function calculateBatch(){
  const rows=document.querySelectorAll('#batchTbody tr');
  if(rows.length===0){
    showNotification(currentLanguage==='ar'?'لا توجد صفوف':'No rows');
    return;
  }
  batchData=[];
  const namesMap={
    morning: currentLanguage==='ar'?'الوردية الصباحية':'Morning',
    morning2: currentLanguage==='ar'?'الوردية الصباحية 2':'Morning 2',
    evening: currentLanguage==='ar'?'الوردية المسائية':'Evening',
    evening2: currentLanguage==='ar'?'الوردية المسائية 2':'Evening 2'
  };
  rows.forEach((r,i)=>{
    const name=r.querySelector('input').value.trim();
    const shift=r.querySelector('.batch-shift').value;
    const usedH=parseInt(r.querySelector('.usedH').value)||0;
    const usedM=parseInt(r.querySelector('.usedM').value)||0;
    const res=calcForShift(shift,usedH,usedM);
    batchData.push({
      index:i+1,
      name,
      shiftKey:shift,
      shiftName:namesMap[shift],
      used:res.used,
      remaining:res.remainingHours,
      leave:res.leaveTime
    });
  });
  renderBatchResults();
  playSound('resultSound');
  showNotification(currentLanguage==='ar'?'تم الحساب':'Calculated');
}

function renderBatchResults(){
  const body=document.getElementById('batchResultsBody');
  body.innerHTML='';
  batchData.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${d.index}</td>
      <td>${d.name||'-'}</td>
      <td>${d.shiftName}</td>
      <td>${d.used}</td>
      <td>${d.remaining}</td>
      <td>${d.leave}</td>
    `;
    body.appendChild(tr);
  });
  document.getElementById('batchResultsContainer').style.display='block';
}

function copyBatchSummary(){
  if(batchData.length===0){calculateBatch();if(batchData.length===0)return;}
  const labels=currentLanguage==='ar'?{
    batch:'ملخص الدفعة',name:'الاسم',shift:'الوردية',used:'المستخدمة',remain:'المتبقي',leave:'الخروج'
  }:{
    batch:'Batch Summary',name:'Name',shift:'Shift',used:'Used',remain:'Remaining',leave:'Leave'
  };
  const lines=[labels.batch,''];
  batchData.forEach(d=>{
    lines.push(`${d.index}. ${labels.name}: ${d.name||'-'} | ${labels.shift}: ${d.shiftName} | ${labels.used}: ${d.used} | ${labels.remain}: ${d.remaining} | ${labels.leave}: ${d.leave}`);
  });
  const text=lines.join('\n');
  navigator.clipboard.writeText(text).then(()=>showNotification(currentLanguage==='ar'?'تم نسخ الملخص':'Summary copied')).catch(()=>showNotification(currentLanguage==='ar'?'فشل النسخ':'Copy failed'));
}

function saveBatchAsPDF(){
  if(batchData.length===0){calculateBatch();if(batchData.length===0)return;}
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Set background
  doc.setFillColor(15, 22, 32);
  doc.rect(0, 0, 210, 297, 'F');
  
  // Title
  doc.setFontSize(18);
  doc.setTextColor(77, 166, 255);
  const title = currentLanguage==='ar'?'تقرير دفعة الساعات':'Batch Hours Report';
  doc.text(title, 105, 20, { align: 'center' });
  
  // Table headers
  const labels=currentLanguage==='ar' ? ['#','الاسم','الوردية','المستخدمة','المتبقي','الخروج']
                                      : ['#','Name','Shift','Used','Remaining','Leave'];
  
  let yPos = 35;
  doc.setFontSize(10);
  doc.setTextColor(77, 166, 255);
  
  // Header row
  const colX = [15, 30, 70, 110, 140, 170];
  labels.forEach((label, i) => {
    doc.text(label, colX[i], yPos);
  });
  
  // Draw header line
  doc.setDrawColor(77, 166, 255);
  doc.line(10, yPos + 2, 200, yPos + 2);
  
  // Data rows
  yPos += 10;
  doc.setFontSize(9);
  doc.setTextColor(227, 240, 255);
  
  batchData.forEach((d, idx) => {
    if(yPos > 270){
      doc.addPage();
      doc.setFillColor(15, 22, 32);
      doc.rect(0, 0, 210, 297, 'F');
      yPos = 20;
    }
    
    doc.text(String(d.index), colX[0], yPos);
    doc.text(d.name||'-', colX[1], yPos);
    doc.text(d.shiftName, colX[2], yPos);
    doc.text(d.used, colX[3], yPos);
    doc.text(d.remaining, colX[4], yPos);
    doc.text(d.leave, colX[5], yPos);
    
    yPos += 8;
  });
  
  // Footer
  const pages = doc.internal.pages.length - 1;
  for(let i=1; i<=pages; i++){
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(77, 166, 255);
    const genLabel=currentLanguage==='ar'?'تم الإنشاء':'Generated';
    doc.text(`${genLabel}: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 290, { align: 'center' });
  }
  
  doc.save('workstime-batch-'+new Date().toISOString().slice(0,10)+'.pdf');
  showNotification(currentLanguage==='ar'?'تم حفظ PDF':'PDF saved');
}

function saveBatchAsImage(){
  if(batchData.length===0){calculateBatch();if(batchData.length===0)return;}
  const canvas=document.getElementById('canvas');
  const ctx=canvas.getContext('2d');
  const rowH=38;
  const headerH=60;
  const topPad=60;
  const baseHeight= topPad + headerH + (batchData.length*rowH) + 80;
  canvas.width=900;
  canvas.height=baseHeight;

  const g=ctx.createLinearGradient(0,0,900,baseHeight);
  g.addColorStop(0,'#0f1620'); g.addColorStop(1,'#050810');
  ctx.fillStyle=g; ctx.fillRect(0,0,900,baseHeight);

  ctx.strokeStyle='rgba(77,166,255,0.07)';
  ctx.lineWidth=1;
  for(let x=0;x<=900;x+=36){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,baseHeight);ctx.stroke();}
  for(let y=0;y<=baseHeight;y+=36){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(900,y);ctx.stroke();}

  ctx.font='bold 38px Share Tech Mono';
  ctx.fillStyle='#4da6ff';
  ctx.textAlign='center';
  ctx.shadowColor='rgba(77,166,255,.7)';
  ctx.shadowBlur=18;
  const title=currentLanguage==='ar'?'تقرير دفعة الساعات':'Batch Hours Report';
  ctx.fillText(title,450,50);
  ctx.shadowBlur=0;

  const labels=currentLanguage==='ar' ? ['#','الاسم','الوردية','المستخدمة','المتبقي','الخروج']
                                      : ['#','Name','Shift','Used','Remaining','Leave'];
  const colWidths=[50,180,170,140,140,160];
  const colStarts=[];
  let acc=40;
  for(let i=0;i<colWidths.length;i++){colStarts.push(acc);acc+=colWidths[i];}

  ctx.font='bold 16px Share Tech Mono';
  ctx.fillStyle='#4da6ff';
  ctx.textAlign='left';
  for(let i=0;i<labels.length;i++){
    ctx.fillText(labels[i],colStarts[i],topPad);
  }
  ctx.strokeStyle='rgba(77,166,255,0.4)';
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(30, topPad+10);
  ctx.lineTo(870, topPad+10);
  ctx.stroke();

  ctx.font='15px Share Tech Mono';
  ctx.fillStyle='#e3f0ff';
  let y=topPad+36;
  batchData.forEach(d=>{
    const vals=[d.index, d.name||'-', d.shiftName, d.used, d.remaining, d.leave];
    for(let i=0;i<vals.length;i++){
      ctx.fillText(vals[i], colStarts[i], y);
    }
    y+=rowH;
  });

  ctx.font='12px Share Tech Mono';
  ctx.fillStyle='#4da6ff';
  ctx.textAlign='center';
  const genLabel=currentLanguage==='ar'?'تم الإنشاء':'Generated';
  ctx.fillText(`${genLabel}: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`,450, baseHeight-30);

  canvas.toBlob(b=>{
    const url=URL.createObjectURL(b);
    const a=document.createElement('a');
    a.href=url;
    a.download='workstime-batch-'+new Date().toISOString().slice(0,10)+'.png';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(currentLanguage==='ar'?'تم حفظ صورة الدفعة':'Batch image saved');
  });
}

// Event listeners
['usedHours','usedMinutes'].forEach(id=>{
  document.addEventListener('change',e=>{
    if(e.target.id===id){
      playSound('clickSound');
      if(document.getElementById('results').classList.contains('show')) calculateResults();
    }
  });
});

// Add sound to all select elements
document.addEventListener('DOMContentLoaded',()=>{
  updateShiftDisplay();
  
  // Add sound effect to all dropdowns
  document.querySelectorAll('select').forEach(sel=>{
    sel.addEventListener('change',()=>playSound('clickSound'));
  });
});

document.addEventListener('keypress',e=>{
  if(e.key==='Enter' && document.getElementById('modeSelect').value==='single') calculateResults();
});
</script>
</body>
</html>
